# 对外SDK如何避免获得P0事故的称号
### 缓存
解决缓存:新增一个外层pullor，在读取SDK cdn地址时，增加一个年月日时的时间戳，并且读取pullor url的版本参数。动态时间戳的好处是既可以随时更新sdk，又不用担心缓存，不用New Date的而用日期加小时做时间戳的好处是既可以充分利用CDN缓存，减少回源量，又充分利用CDN的优势。
从pullor读取url参数的好处是，即可以保证不带参数引用pullor的引用方随发布方更新及时更新，又可以保证引用特定的版本

### 监控

引入方的多种多样可能导致各种五花八本的问题，监控Js的错误，并上报

### JSDK的设计
 1. 不同版本前后兼容性。
 2. 高扩展性 。

### 以广告SDK为例讲解
#### 不同版本的前后兼容性

现在的汇川广告最终渲染分为两种，一种是芳华样式，检索端把替换后的模版JSON数据做为输出，render.js把数据翻译成广告。第二种是非芳华样式，检索端输出的是，模版+数据，前段自己merge并翻译成广告，这个渲染js是feedback。
	如何解决这种完全不同的渲染方式，最佳简单办法就是根据不同的条件在同一个js做if判断，不同的条件使用不同的渲染逻辑。但是如果，不止两种呢，有10种，100种呢?  如果渲染，打点方式千差万别呢，这种方式就会是个无底洞，你会愉快的背上P0事故的美名，也许这是前端唯一背上此美名的机会。
 SDK因为引用方很多，开发完成后，你不可能一一进行回归，所以改的越少风险越小。所以芳华采用了另一种设计，插板。我们知道一个插板可以对应各种插头，只要是国标的，即使是非国标也有转接口。
我在渲染层上又加了一层loader用于加载渲染层，这个就是插板，插板的插口设计应该尽量标准化，这个后面讲，此处按下不表。插头和插头的连接方就是五花八门的renderjs 和 与之相对应的模版。你可以理解为插头可以连接，相机，手机，电视，等等需要电的物体，只要插头的插的进去就成。所以最终SDK层级就是这样：

![111](http://p8.qhimg.com/t01033c452e4f3b9822.png)

如何让render进行隔离呢
我在设计模版的时候，给模版加了一个tpl_version的字段，检索端在渲染广告时，会根据不同version，引用不同的render cdn地址。这样loader和render就完全隔离了，然后你就可以正着渲，反着渲，随你怎么渲。

这种设计解决了两个问题
1 .版本兼容问题，谁都不是神，认知随需求扩大，此种设计只要保证不同阶段产生不同模版和render就可以了。
2.关联改动问题，改动越少，犯错越少，因为是独立文件，所以发布只用发一个就成

### 解决高扩展性问题
随着接入方的增多，接入方的平台也各不相同，自家的web容器也不相同，保证能满足各个平台需求，就能带来更多的流量，带来真金白银，但是众口难调。

举个例子：
1. 书旗小说APP，禁止了window.open 和 默认浏览器下载，需要调用自己APP相应的接口，并且页面缩放值为动态
2. 国际化UC客户端，渲染的时机需要自己括客户端自己把握


针对这种特许情况我们把这种特殊逻辑转嫁到模版，于是整体设计就变成了这样：
1. 让SDK做更少的琐事，只关注全局工作，渲染，事件上抛，报错监控
2. 让模版做具体的事情，交互逻辑，广告打点


￼![111](http://p2.qhimg.com/t0169ed91dbcca09456.png)

这样设计可以带来如下的好处：
针对书旗小说的问题，可以在模版全部解决这些问题。
1. 页面缩放：我们只需要获取当前页面缩放值，在当前模版进行相应的反缩放即可
2. 功能屏蔽：当用户发生点击或者下载我们可以上抛事件至调用方，让他们自己调用APP的几口即可
3. 可以给每个引用方开发个性化的模版

国际化的问题也是同样的方式解决，这里就不说了。

### 总结
1. 使用插板设计去解决新老版本的兼容
2. 模块的逻辑尽量简单单一，坚持自己的原则，不为少数人开发，才能避免频繁的改动上线
3. 通过模版分离和模版事件上抛，去解决千人千面的问题
4. 通过外包cdn的壳去解决cdn缓存，版本区分，及时更新问题

在对外的cdn sdk设计中，我们可以把js切分成多份，在4G的时代用一个请求，去响应国家可持续发展策略，利国利民，功在当代，利在千秋。
